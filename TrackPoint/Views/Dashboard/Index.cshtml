@{
    ViewData["Title"] = "Dashboard";
    bool isAdmin = User.IsInRole("Admin");
}

<style>
    canvas {
        width: 180px !important;
        height: 180px !important;
    }

    .table-div {
        border: 1px solid #D3D3D3;
        border-radius: 10px;
    }

    .badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: #fff;
        display: inline-block;
    }

    /* Red - InUse */
    .badge-red {
        background-color: #FF2B2B;
        color: white;
    }

    /* Orange - Retired */
    .badge-orange {
        background-color: #FF6D1A;
        color: white;
    }

    /* Green - InStorage */
    .badge-green {
        background-color: #00C964;
        color: white;
    }

    /* Blue -CheckedOut */
    .badge-blue {
        background-color: #009EFF;
        color: white; /* readable on yellow */
    }

    /* Orange - UnderMaintenance */
    .badge-yellow {
        background-color: #FFD300;
        color: black;
    }

    .badge-grey {
        background-color: gray;
        color: black;
    }
</style>
<div class="container mt-4 custom-background">

    @* <h2 class="mb-3">Personal Dashboard</h2>  *@
    

    @if (isAdmin)
    {
        <a asp-controller="Dashboard" asp-action="adminDashboard" class="btn btn-light btn-outline-dark btn-sm">Admin View</a>
    }

    <div class="container" style="padding: 18px">
        <div class="row g-4">

            <div class="col-md-4" >
                <div style="border: 1px solid #D3D3D3;border-radius:10px; padding:10px;">
                    <h6>Assets by Location</h6>
                    <canvas id="location"></canvas>
                </div>
            </div>

            <div class="col-md-4">
                <div style="border: 1px solid #D3D3D3;border-radius:10px; padding:10px">
                    <h6>Assets by Status</h6>
                    <canvas id="status"></canvas>
                </div>
            </div>

            <div class="col-md-4">
                <div style="border: 1px solid #D3D3D3;border-radius:10px; padding:10px">
                    <h6>Assets by Make</h6>
                    <canvas id="make"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row align-items-center g-2">
            <div class="col-auto">
                <select id="searchColumn" class="form-select">
                    <option value="__all__">All</option>
                    <option value="0">Asset Tag</option>
                    <option value="1">Make</option>
                    <option value="2">Model</option>
                    <option value="3">Category</option>
                    <option value="4">Location</option>
                    <option value="5">Issued To</option>
                    <option value="6">Status</option>
                    <option value="7">Notes</option>
                </select>
            </div>

            <div class="col-sm">
                <div id="customSearchContainer">
                </div>
            </div>
        </div>
    </div>

    <div class="dropdown mb-3">
        <button class="btn btn-secondary dropdown-toggle" type="button" id="columnToggleDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Toggle Columns
        </button>
        <ul class="dropdown-menu p-3" aria-labelledby="columnToggleDropdown" style="min-width: 200px" data-bs-auto-close="false">

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="0" checked>
                    Asset Tag
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="1" checked>
                    Make
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="2" checked>
                    Model
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="3" checked>
                    Category
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="4" checked>
                    Location
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="5" checked>
                    Issued To
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="6" checked>
                    Status
                </label>
            </li>

            <li>
                <label class="dropdown-item">
                    <input type="checkbox" class="toggle-vis" data-column="7" checked>
                    Notes
                </label>
            </li>

        </ul>
    </div>


        <div class="table-div">
        <table id="assetTable" class="table table-borderless" style="width:100%">
            <thead>
                <tr>
                    <th>Asset Tag</th>
                    <th>Make</th>
                    <th>Model</th>
                    <th>Category</th>
                    <th>Location</th>
                    <th>Issued To</th>
                    <th>Status</th>
                    <th>Notes</th>
                </tr>
            </thead>`   
            <tbody>
                <tr><td>LSNF-001</td><td>Dell</td><td>Latitude 7420</td><td>Tech</td><td>HQ Closet</td><td>Emily</td><td>InUse</td><td>Assigned</td></tr>
                <tr><td>LSNF-002</td><td>HP</td><td>ProBook</td><td>Tech</td><td>HQ Closet</td><td>—</td><td>InStorage</td><td>Spare</td></tr>
                <tr><td>LSNF-003</td><td>Epson</td><td>EX5280</td><td>Tech</td><td>Room 101</td><td>Alex</td><td>UnderMaintenance</td><td>Bulb</td></tr>
                <tr><td>LSNF-001</td><td>Dell</td><td>Latitude 7420</td><td>Tech</td><td>HQ Closet</td><td>Emily</td><td>InUse</td><td>Assigned</td></tr>
                <tr><td>LSNF-002</td><td>HP</td><td>ProBook</td><td>Tech</td><td>HQ Closet</td><td>—</td><td>InStorage</td><td>Spare</td></tr>
                <tr><td>LSNF-003</td><td>Epson</td><td>EX5280</td><td>Tech</td><td>Room 101</td><td>Alex</td><td>UnderMaintenance</td><td>Bulb</td></tr>
                <tr><td>LSNF-004</td><td>Lenovo</td><td>ThinkPad X13</td><td>Tech</td><td>Field Office</td><td>Sarah</td><td>CheckedOut</td><td>Used for outreach event</td></tr>
                <tr><td>LSNF-005</td><td>Canon</td><td>Pixma G3270</td><td>Tech</td><td>HQ Supply Room</td><td>—</td><td>InStorage</td><td>Spare printer</td></tr>
                <tr><td>LSNF-006</td><td>Microsoft</td><td>Surface Pro 7</td><td>Tech</td><td>HQ Desk 4</td><td>Michael</td><td>CheckedOut</td><td>Used for client presentation</td></tr>
                <tr><td>LSNF-007</td><td>Samsung</td><td>Galaxy Tab A7</td><td>Tech</td><td>Outreach Van</td><td>Jasmine</td><td>InUse</td><td>Deployed for field survey</td></tr>
                <tr><td>LSNF-008</td><td>Apple</td><td>MacBook Air M1</td><td>Tech</td><td>HQ Closet</td><td>—</td><td>PendingDeployment</td><td>New hire device</td></tr>
                <tr><td>LSNF-009</td><td>LG</td><td>Projector MiniBeam</td><td>Tech</td><td>Room 202</td><td>Jessica</td><td>CheckedOut</td><td>Training session</td></tr>
                <tr><td>LSNF-010</td><td>Amazon</td><td>Echo Dot</td><td>Non-Tech</td><td>Conference Room</td><td>—</td><td>InUse</td><td>Office automation</td></tr>
                <tr><td>LSNF-011</td><td>Brother</td><td>HL-L2350DW</td><td>Tech</td><td>HQ Printing Station</td><td>—</td><td>InUse</td><td>Main printer</td></tr>
                <tr><td>LSNF-012</td><td>Generic</td><td>Extension Cord</td><td>Non-Tech</td><td>Kit A</td><td>—</td><td>InStorage</td><td>Used for outreach setups</td></tr>
                <tr><td>LSNF-013</td><td>HP</td><td>EliteBook 840</td><td>Tech</td><td>Kit B</td><td>Anthony</td><td>CheckedOut</td><td>Field reporting</td></tr>
                <tr><td>LSNF-014</td><td>Canon</td><td>EOS Rebel T7</td><td>Tech</td><td>HQ Media Closet</td><td>—</td><td>InStorage</td><td>Photo documentation</td></tr>
                <tr><td>LSNF-015</td><td>Logitech</td><td>C920</td><td>Tech</td><td>HQ Closet</td><td>—</td><td>Retired</td><td>Outdated equipment</td></tr>
            </tbody>
        </table>
    </div>


    


<!-- DataTables + jQuery (CDN) -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!--This is the Datatables asset table-->
<script>
     $(function () {

        const table = $('#assetTable').DataTable({
            pageLength: 25,
            ordering: true,
            searching: true,
            stateSave: true,
            lengthChange: false,
                    columnDefs: [
                    {
                        targets: 6,
                        render: function (data) {

                        // Normalize text
                        const clean = (data || "").toString().trim().toLowerCase();

                        // Map normalized values → color classes
                        const map = {
                        "inuse": "red",              // #009EFF
                        "instorage": "green",         // #00C964
                        "undermaintenance": "yellow", // #FF6D1A
                        "pendingdeployment": "orange",// #FFD300
                        "checkedout": "blue",
                        "retired": "grey"
                };

                // Pick color class
                const slug = map[clean] || "blue";  // fallback

                // Return badge HTML
                return `<span class="badge badge-${slug}">${data}</span>`;
            }
                    }
                ],

            initComplete: function () {
                const api = this.api();
                const tableId = api.table().node().id;
                const $filter = $('#' + tableId + '_filter'); // DataTables search wrapper

                // Remove text label from original search bar
                $filter.find('label').contents().filter(function () {
                    return this.nodeType === 3;
                }).remove();

                // Style search input
                $filter.find('input').addClass('form-control me-2');

                // Move search bar to custom container
                $filter.appendTo('#customSearchContainer');

                const searchInput = $filter.find('input');

                // When dropdown changes
                $('#searchColumn').on('change', function () {
                    const column = $(this).val();
                    const text = searchInput.val();

                    if (column === "__all__") {
                        table.columns().search("");     // clear previous column searches
                        table.search(text).draw();      // global search
                    } else {
                        table.search("");               // clear global search
                        table.columns().search("");     // clear all column searches
                        table.column(column).search(text).draw(); // column search
                    }
                });

                // When typing in the search box
                searchInput.on('keyup', function () {
                    const text = this.value;
                    const column = $('#searchColumn').val();

                    if (column === "__all__") {
                        table.columns().search("");
                        table.search(text).draw();
                    } else {
                        table.search("");
                        table.columns().search("");
                        table.column(column).search(text).draw();
                    }
                });

            } // end initComplete
        }); // end DataTable init


        document.querySelectorAll('input.toggle-vis').forEach((checkbox) => {
            checkbox.addEventListener('change', function (e) {
                const colIndex = e.target.getAttribute('data-column');
                const column = table.column(colIndex);
                column.visible(e.target.checked);
            });
        });


        // create charts
        createLocationChart();
        createStatusChart();
        createMakeChart();

    });
    function createLocationChart() {
        const dt = $('#assetTable').DataTable();
        const locationData = dt.column(4).data().toArray();

           // Count occurrences of each location
        const locationCounts = {};
        locationData.forEach(location => {
        locationCounts[location] = (locationCounts[location] || 0) + 1;
    });

    // Sort by count descending and keep top 5
    const top5 = Object.entries(locationCounts)
        .sort((a, b) => b[1] - a[1]) // highest first
        .slice(0, 5);                 // only top 5

    // Convert back to labels and values
    const labels = top5.map(item => item[0]);
    const values = top5.map(item => item[1]);

    console.log(labels, values);

        console.log(labels, values);

        const ctx = document.getElementById('location');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Assets by Location',
                    data: values,
                    borderWidth: 0,
                    backgroundColor: [
                     '#FFD700',  // vibrant yellow/gold
                    '#FF9500', // vibrant orange
                    '#34C759', // vibrant green
                    '#0A84FF', // vibrant blue
                    '#AF52DE'  // vibrant purple
]                   
            
                }]
            },
            options: {
                    plugins: {
                        legend: {
                        display: false, 
                    }
                },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
        });
    }

     function createStatusChart() {
        const dt = $('#assetTable').DataTable();
        const statusData = dt.column(6).data().toArray();

        // assets available vs assets not available
            const statusCounts = {
                Available: 0,
                Unavailable: 0
            };

            statusData.forEach(status => {
                if (status === "InStorage") {
                    statusCounts.Available++;
                } else {
                    statusCounts.Unavailable++;
                }
            });

            const labels = Object.keys(statusCounts);
            const values = Object.values(statusCounts);

            const ctx = document.getElementById('status');
            new Chart(ctx, {
                type: 'doughnut',
                    data: {
                        labels: labels,
                    datasets: [{
                    label: 'Assets by status',
                    data: values,
                    borderWidth: 0,
                    backgroundColor: [
                    '#00C964', // vibrant green (Available)
                    '#FF2B2B', // vibrant red (Unavailable)
                    '#009EFF', // vibrant blue
                    '#FFD300', // vibrant yellow
                    '#FF6D1A'  // vibrant orange],
                    ],
                  
                }]
            },
            options: {
                    plugins: {
                        legend: {
                        display: false, 
                    }
                },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
        });
    }
     function createMakeChart() {
        const dt = $('#assetTable').DataTable();
        const makeData = dt.column(1).data().toArray();

    // Count occurrences of each make
    const makeCounts = {};
    makeData.forEach(make => {
        makeCounts[make] = (makeCounts[make] || 0) + 1;
    });

    // Sort by count descending and keep top 5
    const top5 = Object.entries(makeCounts)
        .sort((a, b) => b[1] - a[1]) // highest first
        .slice(0, 5);                 // only top 5

    // Convert back to labels and values
    const labels = top5.map(item => item[0]);
    const values = top5.map(item => item[1]);

    console.log(labels, values);

        console.log(labels, values);

        const ctx = document.getElementById('make');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Assets by Make',
                    data: values,
                    borderWidth: 0,
                    backgroundColor: [
                    '#00C964', // vibrant green
                    '#007BFF', // vibrant blue
                    '#FFD300', // vibrant yellow
                    '#FF2B2B', // vibrant red
                    '#9B59B6'  // vibrant purple
                ],
                }]
            },
             options: {
                    plugins: {
                        legend: {
                        display: false, 
                    }
                },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
        });
    }
</script>



