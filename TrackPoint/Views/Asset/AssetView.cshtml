@model TrackPoint.Models.Asset
@using Microsoft.AspNetCore.Identity
@inject UserManager<IdentityUser> UserManager // TODO: Needed to get username of borrower, consider replacing this later so injection is not needed.

@{
    ViewData["Title"] = "Asset Details";
}

@if (Model?.AssetTag != null)
{
    var statusRaw = (Model.AssetStatus ?? "").ToString().Trim();
    var statusKey = statusRaw.ToLowerInvariant();

    string statusColorClass;
    if (statusKey == "inuse" || statusKey == "undermaintenance")
    {
        statusColorClass = "text-danger";
    }
    else if (statusKey == "instorage" || statusKey == "transfered" || statusKey == "transferred" || statusKey == "pendingdeployment")
    {
        statusColorClass = "text-success";
    }
    else if (statusKey == "retired" || statusKey == "lost")
    {
        statusColorClass = "text-secondary";
    }
    else
    {
        statusColorClass = "";
    }

    // Model.IssuedToUser.UserName currently does not work, so look up their username by their Id instead.
    var issuedToName = "Unassigned";
    if (!string.IsNullOrWhiteSpace(Model.IssuedToUser?.UserName))
    {
        issuedToName = Model.IssuedToUser.UserName;
    }
    else if (!string.IsNullOrWhiteSpace(Model.IssuedToUserId))
    {
        // Lookup user by Id in dbo.AspNetUsers
        var user = UserManager.FindByIdAsync(Model.IssuedToUserId).GetAwaiter().GetResult();
        issuedToName = user?.UserName ?? "Unassigned";
    }

    var categoryName = Model.Category?.Name ?? (Model.CategoryId > 0 ? $"ID {Model.CategoryId}" : "—");
    var locationName = Model.Location?.Name ?? (Model.LocationId > 0 ? $"ID {Model.LocationId}" : "—");
    var modalId = $"confirmModal-{Model.AssetId}";
    <div class="container">
        <div class="d-flex justify-content-end mb-3">
            <a class="btn btn-warning me-2" asp-controller="Asset" asp-action="Report" asp-route-assetTag="@Model.AssetTag">Report</a>
            <a class="btn btn-secondary" asp-controller="Asset" asp-action="GenerateBarcode" asp-route-assetTag="@Model.AssetTag">Generate Barcode</a>
        </div>

        <div class="row">
            <div class="col-md-6 text-center">
                <img src="https://placehold.co/600x400/000000/FFFFFF.png" class="img-fluid mb-3" alt="Asset image / barcode placeholder" />
                <div class="d-flex justify-content-center gap-2">
                    @if (statusKey == "instorage" || statusKey == "transfered" || statusKey == "transferred" || statusKey == "pendingdeployment")
                    {
                        <button type="button" class="btn btn-success btn-lg" data-bs-toggle="modal" data-bs-target="#@modalId">Borrow</button>

                        <div class="modal fade" id="@modalId" tabindex="-1" aria-labelledby="@($"{modalId}-label")" aria-hidden="true">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="@($"{modalId}-label")">Borrow Asset</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        Are you sure you want to check out asset <strong>@Model.AssetTag</strong>?
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                        <a asp-controller="Asset" asp-action="checkOut" asp-route-assetTag="@Model.AssetTag" class="btn btn-primary">Confirm</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                    else
                    {
                        <button type="button" class="btn btn-secondary btn-lg" disabled title="Cannot borrow">Borrow</button>
                    }

                    <a asp-controller="Asset" asp-action="AuditTrail" asp-route-assetTag="@Model.AssetTag" class="btn btn-primary btn-lg">View Audit Trail</a>
                </div>
            </div>

            <div class="col-md-6">
                <h1 class="text-center">@Model.Make @Model.Model</h1>
                <hr />
                <div class="fs-6">
                    <p><strong>Asset Tag:</strong> @Model.AssetTag</p>
                    <p><strong>Status:</strong> <span class="@statusColorClass">@statusRaw</span></p>
                    <p><strong>Location:</strong> @locationName</p>
                    <p><strong>Category:</strong> @categoryName</p>
                    <p><strong>Serial Number:</strong> @(String.IsNullOrWhiteSpace(Model.SerialNumber) ? "—" : Model.SerialNumber)</p>
                    <p><strong>Issued To:</strong> @issuedToName</p>
                    <p><strong>Purchase Date:</strong> @(Model.PurchaseDate.HasValue? Model.PurchaseDate.Value.ToString("yyyy-MM-dd") : "—")</p>
                    <p><strong>Warranty Expiration:</strong> @(Model.WarrantyExpirationDate.HasValue? Model.WarrantyExpirationDate.Value.ToString("yyyy-MM-dd") : "—")</p>
                    <p><strong>Purchase Price:</strong> @(Model.PurchasePrice != 0 ? Model.PurchasePrice.ToString("C") : "—")</p>
                    <p><strong>Vendor:</strong> @(String.IsNullOrWhiteSpace(Model.Vendor) ? "—" : Model.Vendor)</p>
                    <p><strong>Condition:</strong> @(String.IsNullOrWhiteSpace(Model.Condition) ? "—" : Model.Condition)</p>
                    <p><strong>Notes:</strong> @(String.IsNullOrWhiteSpace(Model.Notes) ? "—" : Model.Notes)</p>
                    <p><strong>Last Status Date:</strong> @(Model.StatusDate != default ? Model.StatusDate.ToString("g") : "—")</p>
                </div>

                <div class="mt-3">
                    <a asp-controller="Asset" asp-action="AssetEdit" asp-route-assetTag="@Model.AssetTag" class="btn btn-outline-warning me-2">Edit</a>
                    <a asp-controller="Asset" asp-action="AssetBrowser" class="btn btn-outline-secondary">Back</a>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="container">
        <div class="alert alert-warning">No asset detected.</div>
        <a asp-controller="Asset" asp-action="AssetBrowser" class="btn btn-secondary">Back to list</a>
    </div>
}